name: Java CI with Maven (Multi-Service)

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    services:
      docker:
        image: docker:19.03.12
        options: --privileged

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Give permission to Maven wrapper
        run: chmod +x mvnw

      - name: Build all services
        run: ./mvnw clean install -DskipTests

      - name: Run all microservices in background
        run: |
          nohup ./mvnw -f discovery-service spring-boot:run &
          sleep 15
          nohup ./mvnw -f api-gateway-service spring-boot:run &
          nohup ./mvnw -f category-service spring-boot:run &
          nohup ./mvnw -f comments-service spring-boot:run &
          nohup ./mvnw -f reservation-service spring-boot:run &
          nohup ./mvnw -f springsecurity-service spring-boot:run &
          sleep 60

      - name: Print services are running
        run: echo "All microservices started successfully!"